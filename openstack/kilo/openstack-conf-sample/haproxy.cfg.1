#---------------------------------------------------------------------
# Example configuration for a possible web application.  See the
# full configuration options online.
#
#   http://haproxy.1wt.eu/download/1.4/doc/configuration.txt
#
#---------------------------------------------------------------------

#---------------------------------------------------------------------
# Global settings
#---------------------------------------------------------------------
global
    # to have these messages end up in /var/log/haproxy.log you will
    # need to:
    #
    # 1) configure syslog to accept network log events.  This is done
    #    by adding the '-r' option to the SYSLOGD_OPTIONS in
    #    /etc/sysconfig/syslog
    #
    # 2) configure local2 events to go to the /var/log/haproxy.log
    #   file. A line like the following can be added to
    #   /etc/sysconfig/syslog
    #
    #    local2.*                       /var/log/haproxy.log
    #
    log 127.0.0.1 local0 notice
    chroot      /var/lib/haproxy
    pidfile     /var/run/haproxy.pid
    maxconn     65536 
    user        haproxy
    group       haproxy
    nbproc 1
    ulimit-n 231097
    tune.ssl.default-dh-param 1024
    daemon

    # turn on stats unix socket
    stats socket /var/lib/haproxy/stats


defaults
        log     global
        mode    http
        option  httplog
        option  dontlognull
        option  forwardfor
        retries 3
        option redispatch
        maxconn 65535
        timeout connect 5s
        timeout client 5m
        timeout server 5m
        timeout check   1s
        timeout http-request    10s
        timeout http-keep-alive 10s

listen Stats *:10000
  mode http
  stats enable
  stats uri /
  stats refresh 15s
  stats show-node
  stats show-legends
  stats hide-version


listen rdb_mysql
  bind 10.142.50.233:3306
  balance  leastconn
  mode  tcp
  option  mysql-check user haproxy
  option  tcpka
  option  tcplog
  option  clitcpka
  option  srvtcpka
  timeout client  28801s
  timeout server  28801s
  server mysql1 10.142.50.19:3305 check inter 2000 rise 2 fall 3
  server mysql2 10.142.50.6:3305 backup check inter 2000 rise 2 fall 3
  server mysql3 10.142.50.7:3305 backup check inter 2000 rise 2 fall 3


listen rabbitmq
  bind 10.142.50.233:5672
  balance  roundrobin
  mode  tcp
  option  tcpka
  timeout client  48h
  timeout server  48h
  server rabbitmq1 10.142.50.19:5672   check inter 5000 rise 2 fall 3
  server rabbitmq2 10.142.50.6:5672  backup check inter 5000 rise 2 fall 3
  server rabbitmq3 10.142.50.7:5672  backup check inter 5000 rise 2 fall 3


listen keystone_common
  bind 10.142.50.233:5000
  balance  roundrobin
  option  httplog
  server keystone1 10.142.50.19:5000 check inter 2000 rise 2 fall 3
  server keystone2 10.142.50.6:5000 check inter 2000 rise 2 fall 3


listen keystone_admin
  bind 10.142.50.233:35357
  balance  roundrobin
  option  httplog
  server keystone1 10.142.50.19:35357 check inter 2000 rise 2 fall 3
  server keystone2 10.142.50.6:35357 check inter 2000 rise 2 fall 3


listen glance_api
  bind 10.142.50.233:9292
  balance  roundrobin
  option  httplog
  server glance1 10.142.50.19:9292 check inter 2000 rise 2 fall 3
  server glance2 10.142.50.6:9292 check inter 2000 rise 2 fall 3


listen glance_registry
  bind 10.142.50.233:9191
  balance  roundrobin
  option  httplog
  server glance1 10.142.50.19:9191 check inter 2000 rise 2 fall 3
  server glance2 10.142.50.6:9191 check inter 2000 rise 2 fall 3


listen nova_compute_api
  bind 10.142.50.233:8774
  balance  roundrobin
  option  httplog
  server coreapi1 10.142.50.19:8774 check inter 2000 rise 2 fall 3
  server coreapi2 10.142.50.6:8774 check inter 2000 rise 2 fall 3


listen nova_metadata_api
  bind 10.142.50.233:8775
  balance  roundrobin
  option  httplog
  server coreapi1 10.142.50.19:8775 check inter 2000 rise 2 fall 3
  server coreapi2 10.142.50.6:8775 check inter 2000 rise 2 fall 3


listen nova_novncproxy
  bind 10.142.50.233:6080
  balance  roundrobin
  option  httplog
  server coreapi1 10.142.50.19:6080 check inter 2000 rise 2 fall 3
  server coreapi2 10.142.50.6:6080 check inter 2000 rise 2 fall 3


listen neutron_api
  bind 10.142.50.233:9696
  balance  roundrobin
  option  httplog
  #server coreapi1 10.142.50.49:9696 check inter 2000 rise 2 fall 3
  server coreapi1 10.142.50.19:9696 check inter 2000 rise 2 fall 3
  server coreapi2 10.142.50.6:9696 check inter 2000 rise 2 fall 3


listen horizon
  bind 10.142.50.233:80
  balance  source
  capture  cookie vgnvisitor= len 32
  cookie  SERVERID insert indirect nocache
  mode  http
  option  forwardfor
  option  httpchk
  option  httpclose
  option  httplog
  rspidel  ^Set-cookie:\ IP=
  timeout  client 3h
  timeout  server 3h
  server coreapi1 10.142.50.19:80 cookie coreapi1 check inter 2000 rise 2 fall 3
  server coreapi2 10.142.50.6:80 cookie coreapi2 check inter 2000 rise 2 fall 3


listen cinder_api
  bind 10.142.50.233:8776
  balance  roundrobin
  option  httplog
  server cinder1 10.142.50.7:8776 check inter 2000 rise 2 fall 3
  #server cinder1 10.142.50.19:8776 check inter 2000 rise 2 fall 3
  #server cinder2 10.142.50.6:8776 check inter 2000 rise 2 fall 3
        
